<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pehchaan Setu — Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* Small custom styles */
    .tab { cursor:pointer; padding:8px 12px; border-radius:8px; border:1px solid #e6edf7; background:#fff; }
    .tab.active { background:#2563eb; color:#fff; border-color:transparent; }
    .card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 6px 20px rgba(15,23,42,0.04); }
    .small { font-size:13px; color:#6b7280; }
    .danger { background:#ef4444; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">

  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-blue-700">Pehchaan Setu — Profile</h1>
        <p id="emailLine" class="small mt-1"></p>
      </div>
      <div class="flex items-center gap-3">
        <button id="editProfile" class="border rounded px-3 py-2">Edit profile</button>
        <button id="signOut" class="bg-blue-600 text-white px-4 py-2 rounded">Sign out</button>
      </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Left column: basic card & about -->
      <section class="col-span-2 space-y-6">
        <div class="card flex items-center gap-4">
          <div style="width:80px;height:80px;border-radius:999px;background:#eef2f7;display:flex;align-items:center;justify-content:center;">
            <img id="photo" src="" alt="" style="width:68px;height:68px;border-radius:999px;object-fit:cover;display:none;">
            <div id="avatarPlaceholder" style="font-size:24px;color:#9aa7b9;">—</div>
          </div>
          <div>
            <div id="displayName" class="text-xl font-semibold">—</div>
            <div id="headline" class="small">—</div>
            <div class="mt-2 small">UID: <span id="uidView" class="font-mono text-sm"></span></div>
          </div>
        </div>

        <div id="aboutCard" class="card">
          <h3 class="font-semibold mb-2">About</h3>
          <p id="aboutText" class="small">—</p>
        </div>

        <!-- Tabs -->
        <div class="card">
          <div class="flex gap-3 mb-4" id="tabs">
            <div class="tab active" data-tab="activity">Activity</div>
            <div class="tab" data-tab="experience">Experience</div>
            <div class="tab" data-tab="education">Education</div>
            <div class="tab" data-tab="skills">Skills</div>
            <div class="tab" data-tab="languages">Languages</div>
          </div>

          <!-- Tab content containers -->
          <div id="tabContents">
            <!-- ACTIVITY (empty placeholder) -->
            <div class="tabContent" data-content="activity">
              <p class="small mb-3">Recent activity will appear here (coming soon).</p>
            </div>

            <!-- EXPERIENCE -->
            <div class="tabContent hidden" data-content="experience">
              <h4 class="font-medium mb-2">Experience</h4>
              <div id="experienceList" class="space-y-3 mb-4"></div>

              <h5 class="font-medium mb-2">Add Experience</h5>
              <div class="space-y-2">
                <input id="expCompany" placeholder="Company" class="w-full p-2 border rounded" />
                <input id="expTitle" placeholder="Title" class="w-full p-2 border rounded" />
                <input id="expYears" placeholder="Years (e.g. 2019-2021)" class="w-full p-2 border rounded" />
                <textarea id="expNotes" placeholder="Notes" class="w-full p-2 border rounded"></textarea>
                <div class="flex justify-end">
                  <button id="addExperience" class="bg-blue-600 text-white px-4 py-2 rounded">Add Experience</button>
                </div>
              </div>
            </div>

            <!-- EDUCATION -->
            <div class="tabContent hidden" data-content="education">
              <h4 class="font-medium mb-2">Education</h4>
              <div id="educationList" class="space-y-3 mb-4"></div>

              <h5 class="font-medium mb-2">Add Education</h5>
              <div class="space-y-2">
                <input id="eduSchool" placeholder="School / College" class="w-full p-2 border rounded" />
                <input id="eduDegree" placeholder="Degree" class="w-full p-2 border rounded" />
                <input id="eduYear" placeholder="Year" class="w-full p-2 border rounded" />
                <textarea id="eduDesc" placeholder="Notes" class="w-full p-2 border rounded"></textarea>
                <div class="flex justify-end">
                  <button id="addEducation" class="bg-blue-600 text-white px-4 py-2 rounded">Add Education</button>
                </div>
              </div>
            </div>

            <!-- SKILLS -->
            <div class="tabContent hidden" data-content="skills">
              <h4 class="font-medium mb-2">Skills</h4>
              <div id="skillsList" class="space-y-2 mb-4"></div>

              <div class="flex gap-2">
                <input id="skillInput" placeholder="Skill (e.g. React, Excel)" class="flex-1 p-2 border rounded" />
                <button id="addSkill" class="bg-blue-600 text-white px-4 py-2 rounded">Add</button>
              </div>
            </div>

            <!-- LANGUAGES -->
            <div class="tabContent hidden" data-content="languages">
              <h4 class="font-medium mb-2">Languages</h4>
              <div id="languagesList" class="space-y-2 mb-4"></div>

              <div class="flex gap-2">
                <input id="langInput" placeholder="Language (e.g. Hindi — Fluent)" class="flex-1 p-2 border rounded" />
                <button id="addLang" class="bg-blue-600 text-white px-4 py-2 rounded">Add</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Right column: quick profile & debug -->
      <aside class="space-y-4">
        <div class="card">
          <h4 class="font-semibold mb-2">Quick actions</h4>
          <div class="space-y-2">
            <button id="refreshBtn" class="w-full border rounded px-3 py-2">Refresh</button>
            <button id="exportBtn" class="w-full border rounded px-3 py-2">Export profile JSON</button>
          </div>
        </div>

        <div class="card">
          <h4 class="font-semibold mb-2">Profile</h4>
          <div class="small">UID: <span id="uidView2" class="font-mono"></span></div>
          <div class="small mt-2">Signed in: <span id="signedInAt">—</span></div>
        </div>

        <div id="errorCard" class="card text-red-600 hidden"></div>
      </aside>
    </main>
  </div>

  <!-- Firebase compat v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- your firebase-config.js (must initialize firebase) -->
  <script src="firebase-config.js"></script>

  <script>
  (function(){
    // Small helpers
    const $ = id => document.getElementById(id);
    const showError = (msg) => {
      const el = $('errorCard');
      el.classList.remove('hidden');
      el.textContent = msg;
      console.error('[profile] ' + msg);
    };
    const clearError = () => { const el = $('errorCard'); el.classList.add('hidden'); el.textContent = ''; };

    // Ensure firebase loaded
    if (!window.firebase || !firebase.auth || !firebase.firestore) {
      showError('Firebase not loaded. Make sure firebase-config.js and compat SDKs are included.');
      return;
    }

    const auth = firebase.auth();
    const db = firebase.firestore();
    const USERS = 'users';

    // UI refs
    const emailLine = $('emailLine');
    const displayName = $('displayName');
    const headline = $('headline');
    const aboutText = $('aboutText');
    const photoEl = $('photo');
    const avatarPlaceholder = $('avatarPlaceholder');
    const uidView = $('uidView');
    const uidView2 = $('uidView2');
    const signedInAt = $('signedInAt');

    // Tabs
    document.querySelectorAll('#tabs .tab').forEach(t => {
      t.addEventListener('click', () => {
        document.querySelectorAll('#tabs .tab').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        const tab = t.getAttribute('data-tab');
        document.querySelectorAll('.tabContent').forEach(c => {
          c.classList.toggle('hidden', c.getAttribute('data-content') !== tab);
        });
      });
    });

    // protect page: redirect to login if not signed in
    auth.onAuthStateChanged(user => {
      if (!user) {
        // not signed in
        console.log('[profile] user not signed in, redirecting to login');
        window.location.href = 'auth-login.html';
        return;
      }
      // logged in -> initialize UI
      initForUser(user);
    });

    // Sign out
    $('signOut').addEventListener('click', () => {
      auth.signOut().then(()=> location.href='auth-login.html');
    });

    // Refresh / Export
    $('refreshBtn').addEventListener('click', () => {
      if (auth.currentUser) loadUserDoc(auth.currentUser.uid);
    });
    $('exportBtn').addEventListener('click', async () => {
      if (!auth.currentUser) return showError('Not signed in');
      const snap = await db.collection(USERS).doc(auth.currentUser.uid).get();
      const data = (snap.exists && snap.data()) || {};
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'profile-'+auth.currentUser.uid+'.json'; a.click();
      URL.revokeObjectURL(url);
    });

    // Initialize for a logged-in user
    function initForUser(user) {
      clearError();
      console.log('[profile] signed in as', user.uid, user.email);
      emailLine.textContent = user.email || '';
      uidView.textContent = user.uid;
      uidView2.textContent = user.uid;
      signedInAt.textContent = (new Date()).toLocaleString();

      // show display name / avatar
      displayName.textContent = user.displayName || '—';
      if (user.photoURL) {
        photoEl.src = user.photoURL; photoEl.style.display = 'block'; avatarPlaceholder.style.display='none';
      } else {
        photoEl.style.display = 'none'; avatarPlaceholder.style.display='block';
      }

      // load and listen to user's doc
      const docRef = db.collection(USERS).doc(user.uid);
      docRef.onSnapshot(snap => {
        const data = (snap.exists && snap.data()) || {};
        renderProfileData(data);
      }, err => {
        showError('Failed to listen to profile: ' + (err && err.message));
      });

      // Hook add handlers
      attachAddHandlers(user);
    }

    function renderProfileData(data) {
      // about
      aboutText.textContent = data.about || '—';

      // experience
      renderArrayList('experienceList', data.experience || [], ['company','title','years','notes']);

      // education
      renderArrayList('educationList', data.education || [], ['school','degree','year','notes']);

      // skills
      renderSimpleList('skillsList', data.skills || []);

      // languages
      renderSimpleList('languagesList', data.languages || []);
    }

    function renderArrayList(containerId, arr, fields) {
      const el = $(containerId);
      if (!el) return;
      el.innerHTML = '';
      if (!arr.length) {
        const p = document.createElement('div'); p.className='small'; p.textContent='—'; el.appendChild(p); return;
      }
      arr.slice().reverse().forEach(item => {
        const card = document.createElement('div'); card.className='p-3 border rounded';
        const title = document.createElement('div'); title.className='font-semibold';
        title.textContent = item[fields[0]] || item.school || '—';
        card.appendChild(title);

        const meta = document.createElement('div'); meta.className='small text-gray-600';
        meta.textContent = (item[fields[1]] || '') + (item[fields[2]] ? ' • ' + item[fields[2]] : '');
        card.appendChild(meta);

        if (item[fields[3]]) {
          const notes = document.createElement('div'); notes.className='mt-2 small';
          notes.textContent = item[fields[3]];
          card.appendChild(notes);
        }

        // delete button
        const del = document.createElement('button'); del.className='danger mt-3';
        del.textContent = 'Delete';
        del.addEventListener('click', () => removeArrayItem(item.id, containerId.replace('List','')));
        card.appendChild(del);

        el.appendChild(card);
      });
    }

    function renderSimpleList(containerId, arr) {
      const el = $(containerId);
      if (!el) return;
      el.innerHTML = '';
      if (!arr.length) { el.innerHTML = '<div class="small">—</div>'; return; }
      arr.slice().reverse().forEach((val) => {
        const row = document.createElement('div'); row.className='p-2 border rounded flex justify-between items-center';
        const left = document.createElement('div'); left.textContent = val;
        const btn = document.createElement('button'); btn.className='danger'; btn.textContent='Delete';
        btn.addEventListener('click', () => removeSimpleItem(val, containerId.replace('List','')));
        row.appendChild(left); row.appendChild(btn); el.appendChild(row);
      });
    }

    // ---------- add handlers for each section ----------
    function attachAddHandlers(user) {
      // Education
      $('addEducation').addEventListener('click', async () => {
        clearError();
        const school = $('eduSchool').value.trim();
        if (!school) return showError('School required');
        const entry = {
          id: 'edu_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8),
          school,
          degree: $('eduDegree').value.trim() || '',
          year: $('eduYear').value.trim() || '',
          notes: $('eduDesc').value.trim() || '',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await pushArrayItem(user.uid, 'education', entry);
        $('eduSchool').value=''; $('eduDegree').value=''; $('eduYear').value=''; $('eduDesc').value='';
      });

      // Experience
      $('addExperience').addEventListener('click', async () => {
        clearError();
        const company = $('expCompany').value.trim();
        if (!company) return showError('Company required');
        const entry = {
          id: 'exp_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8),
          company,
          title: $('expTitle').value.trim()||'',
          years: $('expYears').value.trim()||'',
          notes: $('expNotes').value.trim()||'',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await pushArrayItem(user.uid, 'experience', entry);
        $('expCompany').value=''; $('expTitle').value=''; $('expYears').value=''; $('expNotes').value='';
      });

      // Skills
      $('addSkill').addEventListener('click', async () => {
        clearError();
        const v = $('skillInput').value.trim();
        if (!v) return showError('Skill required');
        await pushSimpleItem(user.uid, 'skills', v);
        $('skillInput').value='';
      });

      // Languages
      $('addLang').addEventListener('click', async () => {
        clearError();
        const v = $('langInput').value.trim();
        if (!v) return showError('Language required');
        await pushSimpleItem(user.uid, 'languages', v);
        $('langInput').value='';
      });
    }

    // ---------- helpers to push array items atomically ----------
    async function pushArrayItem(uid, field, item) {
      try {
        const docRef = db.collection(USERS).doc(uid);
        await db.runTransaction(async tx => {
          const snap = await tx.get(docRef);
          const current = (snap.exists && snap.data()[field]) || [];
          const newArr = Array.isArray(current) ? current.slice() : [];
          newArr.push(item);
          tx.set(docRef, { [field]: newArr }, { merge: true });
        });
        console.log('[profile] pushed item to', field);
      } catch (err) {
        showError('Save failed: ' + (err && err.message));
      }
    }

    async function pushSimpleItem(uid, field, value) {
      try {
        const docRef = db.collection(USERS).doc(uid);
        await db.runTransaction(async tx => {
          const snap = await tx.get(docRef);
          const current = (snap.exists && snap.data()[field]) || [];
          const arr = Array.isArray(current) ? current.slice() : [];
          arr.push(value);
          tx.set(docRef, { [field]: arr }, { merge: true });
        });
        console.log('[profile] pushed simple item to', field);
      } catch (err) {
        showError('Save failed: ' + (err && err.message));
      }
    }

    // remove array item by id
    async function removeArrayItem(itemId, field) {
      if (!auth.currentUser) return showError('Not signed in');
      try {
        const docRef = db.collection(USERS).doc(auth.currentUser.uid);
        await db.runTransaction(async tx => {
          const snap = await tx.get(docRef);
          const data = snap.exists ? snap.data() : {};
          const arr = Array.isArray(data[field]) ? data[field].filter(x => x.id !== itemId) : [];
          tx.set(docRef, { [field]: arr }, { merge: true });
        });
      } catch (err) {
        showError('Delete failed: ' + (err && err.message));
      }
    }

    // remove simple value
    async function removeSimpleItem(value, field) {
      if (!auth.currentUser) return showError('Not signed in');
      try {
        const docRef = db.collection(USERS).doc(auth.currentUser.uid);
        await db.runTransaction(async tx => {
          const snap = await tx.get(docRef);
          const data = snap.exists ? snap.data() : {};
          const arr = Array.isArray(data[field]) ? data[field].filter(x => x !== value) : [];
          tx.set(docRef, { [field]: arr }, { merge: true });
        });
      } catch (err) {
        showError('Delete failed: ' + (err && err.message));
      }
    }

    // Load user doc initially (optional)
    async function loadUserDoc(uid) {
      try {
        const snap = await db.collection(USERS).doc(uid).get();
        const data = (snap.exists && snap.data()) || {};
        renderProfileData(data);
      } catch (err) {
        showError('Failed to load profile: ' + (err && err.message));
      }
    }

    // Render helpers (for initial manual render)
    function renderProfileData(data) {
      $('aboutText').textContent = data.about || '—';
      renderArrayList('educationList', data.education || [], ['school','degree','year','notes']);
      renderArrayList('experienceList', data.experience || [], ['company','title','years','notes']);
      renderSimpleList('skillsList', data.skills || []);
      renderSimpleList('languagesList', data.languages || []);
    }
    // (renderArrayList/renderSimpleList same as above; but we already use onSnapshot to update live)
    function renderArrayList(containerId, arr, fields) {
      const el = $(containerId); if (!el) return;
      el.innerHTML = '';
      if (!arr.length) { el.innerHTML = '<div class="small">—</div>'; return; }
      arr.slice().reverse().forEach(item => {
        const card = document.createElement('div'); card.className='p-3 border rounded';
        const title = document.createElement('div'); title.className='font-semibold'; title.textContent = item[fields[0]] || '—';
        card.appendChild(title);
        const meta = document.createElement('div'); meta.className='small text-gray-600'; meta.textContent = (item[fields[1]]||'') + (item[fields[2]] ? ' • ' + item[fields[2]] : '');
        card.appendChild(meta);
        if (item[fields[3]]) { const notes = document.createElement('div'); notes.className='mt-2 small'; notes.textContent = item[fields[3]]; card.appendChild(notes); }
        const del = document.createElement('button'); del.className='danger mt-3'; del.textContent='Delete';
        del.addEventListener('click', () => removeArrayItem(item.id, containerId.replace('List','')));
        card.appendChild(del);
        el.appendChild(card);
      });
    }
    function renderSimpleList(containerId, arr) {
      const el = $(containerId); if (!el) return;
      el.innerHTML = '';
      if (!arr.length) { el.innerHTML = '<div class="small">—</div>'; return; }
      arr.slice().reverse().forEach(val => {
        const row = document.createElement('div'); row.className='p-2 border rounded flex justify-between items-center';
        const left = document.createElement('div'); left.textContent = val;
        const btn = document.createElement('button'); btn.className='danger'; btn.textContent='Delete';
        btn.addEventListener('click', () => removeSimpleItem(val, containerId.replace('List','')));
        row.appendChild(left); row.appendChild(btn); el.appendChild(row);
      });
    }

    // done
    console.log('[profile] script loaded');
  })();
  </script>
</body>
</html>
