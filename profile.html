<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pehchaan Setu — Profile</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50:  '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af'
            }
          }
        }
      }
    }
  </script>

  <!-- Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .tab-active{background:#1d4ed8;color:#fff}
    .tab-inactive{background:#f3f4f6;color:#111827}
    .glass{backdrop-filter:saturate(180%) blur(10px)}
  </style>
</head>
<body class="bg-slate-50">

  <!-- Top Bar -->
  <header class="sticky top-0 z-40 glass bg-white/80 shadow-sm">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg bg-brand-600 grid place-items-center text-white font-semibold">PS</div>
        <div class="text-slate-800 font-semibold">Pehchaan Setu — Profile</div>
      </div>
      <div class="flex items-center gap-3">
        <button id="editProfileBtn" class="px-3 py-1.5 rounded-md bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">Edit profile</button>
        <button id="signOutBtn" class="px-3 py-1.5 rounded-md bg-red-500 hover:bg-red-600 text-white text-sm">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Page -->
  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left column: Profile card + tabs -->
    <section class="lg:col-span-2 space-y-6">
      <!-- Profile card -->
      <div class="bg-white shadow-sm rounded-xl p-6">
        <div class="flex items-center gap-4">
          <img id="avatar" class="w-16 h-16 rounded-full ring-2 ring-white shadow" src="https://ui-avatars.com/api/?name=%3F&background=2563eb&color=fff" alt="avatar">
          <div class="min-w-0">
            <div id="displayName" class="text-lg font-semibold text-slate-800 truncate">—</div>
            <div id="email" class="text-sm text-slate-500 truncate">—</div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="bg-white shadow-sm rounded-xl">
        <div class="p-3 flex flex-wrap gap-2 border-b">
          <button data-tab="about"      class="tab tab-active px-3 py-1.5 rounded-md text-sm">About</button>
          <button data-tab="activity"   class="tab tab-inactive px-3 py-1.5 rounded-md text-sm">Activity</button>
          <button data-tab="experience" class="tab tab-inactive px-3 py-1.5 rounded-md text-sm">Experience</button>
          <button data-tab="education"  class="tab tab-inactive px-3 py-1.5 rounded-md text-sm">Education</button>
          <button data-tab="skills"     class="tab tab-inactive px-3 py-1.5 rounded-md text-sm">Skills</button>
          <button data-tab="languages"  class="tab tab-inactive px-3 py-1.5 rounded-md text-sm">Languages</button>
        </div>

        <!-- Panels -->
        <div class="p-6 space-y-8">

          <!-- About -->
          <div id="panel-about">
            <div class="flex items-center justify-between">
              <h3 class="text-slate-800 font-semibold">About</h3>
              <button id="saveAboutBtn" class="hidden px-3 py-1.5 rounded-md bg-brand-600 hover:bg-brand-700 text-white text-sm">Save</button>
            </div>
            <textarea id="aboutInput" rows="4" class="mt-3 w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-brand-600" placeholder="Write something about yourself…"></textarea>
          </div>

          <!-- Activity (placeholder) -->
          <div id="panel-activity" class="hidden">
            <p class="text-slate-500 text-sm">Activity feed is coming soon.</p>
          </div>

          <!-- Experience -->
          <div id="panel-experience" class="hidden">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-slate-800 font-semibold">Experience</h3>
              <button class="btn-add" data-open="modal-experience">Add</button>
            </div>
            <div id="experienceList" class="space-y-3"></div>
          </div>

          <!-- Education -->
          <div id="panel-education" class="hidden">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-slate-800 font-semibold">Education</h3>
              <button class="btn-add" data-open="modal-education">Add</button>
            </div>
            <div id="educationList" class="space-y-3"></div>
          </div>

          <!-- Skills -->
          <div id="panel-skills" class="hidden">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-slate-800 font-semibold">Skills</h3>
              <button class="btn-add" data-open="modal-skill">Add</button>
            </div>
            <div id="skillsList" class="flex flex-wrap gap-2"></div>
          </div>

          <!-- Languages -->
          <div id="panel-languages" class="hidden">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-slate-800 font-semibold">Languages</h3>
              <button class="btn-add" data-open="modal-language">Add</button>
            </div>
            <div id="languagesList" class="flex flex-col gap-3"></div>
          </div>

        </div>
      </div>
    </section>

    <!-- Right column: Quick info -->
    <aside class="space-y-6">
      <div class="bg-white shadow-sm rounded-xl p-6">
        <h4 class="text-slate-800 font-semibold mb-4">Quick actions</h4>
        <div class="space-y-2">
          <button id="refreshBtn" class="w-full px-3 py-2 rounded-md bg-slate-100 hover:bg-slate-200">Refresh</button>
          <button id="exportBtn"  class="w-full px-3 py-2 rounded-md bg-slate-100 hover:bg-slate-200">Export profile JSON</button>
        </div>
        <div class="mt-6 text-xs text-slate-500">
          <div>UID: <span id="uid">—</span></div>
          <div class="mt-1">Updated: <span id="updatedAt">—</span></div>
        </div>
      </div>
    </aside>

  </main>

  <!-- Modals -->
  <div id="modalOverlay" class="hidden fixed inset-0 bg-black/40 z-50"></div>

  <!-- Experience modal -->
  <div id="modal-experience" class="modal hidden">
    <div class="modal-card">
      <h3 class="modal-title">Add Experience</h3>
      <div class="modal-body">
        <input id="expCompany" class="input" placeholder="Company">
        <input id="expTitle"   class="input" placeholder="Title">
        <div class="grid grid-cols-2 gap-3">
          <input id="expFrom" class="input" placeholder="From (YYYY-MM)">
          <input id="expTo"   class="input" placeholder="To (YYYY-MM or Present)">
        </div>
        <textarea id="expDesc" rows="3" class="input" placeholder="Description"></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" data-close>Cancel</button>
        <button id="saveExperience" class="btn-primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Education modal -->
  <div id="modal-education" class="modal hidden">
    <div class="modal-card">
      <h3 class="modal-title">Add Education</h3>
      <div class="modal-body">
        <input id="eduSchool" class="input" placeholder="School / College">
        <input id="eduDegree" class="input" placeholder="Degree">
        <input id="eduYear"   class="input" placeholder="Year (e.g., 2020)">
        <textarea id="eduNotes" rows="3" class="input" placeholder="Notes"></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" data-close>Cancel</button>
        <button id="saveEducation" class="btn-primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Skill modal -->
  <div id="modal-skill" class="modal hidden">
    <div class="modal-card">
      <h3 class="modal-title">Add Skill</h3>
      <div class="modal-body">
        <input id="skillName" class="input" placeholder="Skill (e.g., React)">
        <select id="skillLevel" class="input">
          <option value="Beginner">Beginner</option>
          <option value="Intermediate">Intermediate</option>
          <option value="Advanced">Advanced</option>
          <option value="Expert">Expert</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" data-close>Cancel</button>
        <button id="saveSkill" class="btn-primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Language modal -->
  <div id="modal-language" class="modal hidden">
    <div class="modal-card">
      <h3 class="modal-title">Add Language</h3>
      <div class="modal-body">
        <input id="langName" class="input" placeholder="Language (e.g., Hindi)">
        <select id="langProficiency" class="input">
          <option value="Basic">Basic</option>
          <option value="Conversational">Conversational</option>
          <option value="Fluent">Fluent</option>
          <option value="Native">Native</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" data-close>Cancel</button>
        <button id="saveLanguage" class="btn-primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Tiny UI helpers -->
  <style>
    .btn-add{ @apply px-3 py-1.5 rounded-md bg-brand-600 hover:bg-brand-700 text-white text-sm; }
    .modal{ @apply fixed inset-0 z-50 flex items-center justify-center; }
    .modal-card{ @apply bg-white w-full max-w-lg rounded-xl shadow-lg p-6; }
    .modal-title{ @apply text-lg font-semibold text-slate-800 mb-4; }
    .modal-body{ @apply space-y-3; }
    .modal-actions{ @apply mt-5 flex justify-end gap-2; }
    .btn-primary{ @apply px-3 py-1.5 rounded-md bg-brand-600 hover:bg-brand-700 text-white; }
    .btn-secondary{ @apply px-3 py-1.5 rounded-md bg-slate-100 hover:bg-slate-200; }
    .input{ @apply w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-brand-600; }
    .pill{ @apply inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-slate-100 text-slate-700 text-xs; }
    .pill-btn{ @apply hover:bg-red-100 text-red-500 rounded-full px-1.5; }
  </style>

  <!-- Firebase (compat v8, same as your project) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="firebase-config.js"></script>

  <script>
  // ---------- UTIL ----------
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
  function toast(msg, ok=true){
    const t = document.createElement('div');
    t.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded-md shadow-lg text-white ' + (ok?'bg-emerald-600':'bg-red-500');
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(()=>{ t.remove(); }, 2200);
  }
  function ts(d){ return d ? new Date(d.seconds?d.seconds*1000:d).toLocaleString() : '—'; }

  // ---------- AUTH GUARD ----------
  let auth, db, user;
  firebase.auth().onAuthStateChanged(async (u)=>{
    if(!u){ location.href = 'auth-login.html'; return; }
    auth = firebase.auth();
    db   = firebase.firestore();
    user = u;
    $('#uid').textContent = u.uid;
    $('#email').textContent = u.email || '—';
    $('#displayName').textContent = u.displayName || '—';
    if (u.photoURL) $('#avatar').src = u.photoURL;

    // load base doc + lists
    await ensureUserDoc();
    loadAbout();
    bindLists();
  });

  async function ensureUserDoc(){
    const ref = db.collection('users').doc(user.uid);
    const snap = await ref.get();
    if(!snap.exists){
      await ref.set({
        email: user.email || '',
        fullName: user.displayName || '',
        photoURL: user.photoURL || '',
        about: '',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  }

  // ---------- TABS ----------
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tab = btn.dataset.tab;
      $$('.tab').forEach(b=>b.classList.remove('tab-active','text-white'));
      $$('.tab').forEach(b=>b.classList.add('tab-inactive'));
      btn.classList.remove('tab-inactive');
      btn.classList.add('tab-active','text-white');

      ['about','activity','experience','education','skills','languages']
        .forEach(id => $('#panel-'+id).classList.add('hidden'));
      $('#panel-'+tab).classList.remove('hidden');
    });
  });

  // ---------- ABOUT ----------
  const aboutInput = $('#aboutInput');
  const saveAboutBtn = $('#saveAboutBtn');

  function loadAbout(){
    db.collection('users').doc(user.uid).onSnapshot(s=>{
      const d = s.data() || {};
      aboutInput.value = d.about || '';
      $('#updatedAt').textContent = ts(d.updatedAt);
      if (d.photoURL) $('#avatar').src = d.photoURL;
      if (d.fullName) $('#displayName').textContent = d.fullName;
    });
  }
  let dirtyAbout=false;
  aboutInput.addEventListener('input', ()=>{ saveAboutBtn.classList.remove('hidden'); dirtyAbout=true; });
  saveAboutBtn.addEventListener('click', async ()=>{
    if(!dirtyAbout) return;
    await db.collection('users').doc(user.uid)
      .set({ about: aboutInput.value.trim(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    dirtyAbout=false; saveAboutBtn.classList.add('hidden'); toast('About saved');
  });

  // ---------- LIST HELPERS (render, add, delete) ----------
  function renderCard({title, subtitle, right, body, onDel}){
    const div = document.createElement('div');
    div.className = 'p-4 rounded-lg border bg-white flex flex-col gap-1';
    div.innerHTML = `
      <div class="flex items-start justify-between">
        <div>
          <div class="font-medium text-slate-800">${title||'—'}</div>
          ${subtitle ? `<div class="text-sm text-slate-500">${subtitle}</div>`:''}
        </div>
        <div class="text-xs text-slate-500">${right||''}</div>
      </div>
      ${body ? `<div class="text-sm text-slate-600 mt-2 whitespace-pre-line">${body}</div>`:''}
      <div class="mt-2">
        <button class="text-xs text-red-600 hover:underline" data-del>Delete</button>
      </div>
    `;
    if(onDel){ div.querySelector('[data-del]').addEventListener('click', onDel); }
    return div;
  }

  function chip(text, sub, onDel){
    const el = document.createElement('span');
    el.className = 'pill';
    el.innerHTML = `<span>${text}${sub?` · ${sub}`:''}</span><button class="pill-btn" title="Remove">✕</button>`;
    el.querySelector('button').addEventListener('click', onDel);
    return el;
  }

  // EXPERIENCE
  function bindExperience(){
    const wrap = $('#experienceList');
    db.collection('users').doc(user.uid).collection('experience').orderBy('from','desc')
      .onSnapshot(snap=>{
        wrap.innerHTML=''; 
        snap.forEach(doc=>{
          const d = doc.data();
          wrap.appendChild(
            renderCard({
              title: d.title || '—',
              subtitle: d.company || '',
              right: `${d.from||''} – ${d.to||''}`,
              body: d.description || '',
              onDel: async ()=>{ await doc.ref.delete(); toast('Experience removed'); }
            })
          );
        });
      });
  }

  // EDUCATION
  function bindEducation(){
    const wrap = $('#educationList');
    db.collection('users').doc(user.uid).collection('education').orderBy('year','desc')
      .onSnapshot(snap=>{
        wrap.innerHTML='';
        snap.forEach(doc=>{
          const d = doc.data();
          wrap.appendChild(
            renderCard({
              title: d.school || '—',
              subtitle: d.degree || '',
              right: d.year || '',
              body: d.notes || '',
              onDel: async ()=>{ await doc.ref.delete(); toast('Education removed'); }
            })
          );
        });
      });
  }

  // SKILLS
  function bindSkills(){
    const wrap = $('#skillsList');
    db.collection('users').doc(user.uid).collection('skills').orderBy('name')
      .onSnapshot(snap=>{
        wrap.innerHTML='';
        snap.forEach(doc=>{
          const d = doc.data();
          wrap.appendChild(
            chip(d.name || '—', d.level || '', async ()=>{ await doc.ref.delete(); toast('Skill removed'); })
          );
        });
      });
  }

  // LANGUAGES
  function bindLanguages(){
    const wrap = $('#languagesList');
    db.collection('users').doc(user.uid).collection('languages').orderBy('name')
      .onSnapshot(snap=>{
        wrap.innerHTML='';
        snap.forEach(doc=>{
          const d = doc.data();
          wrap.appendChild(
            renderCard({
              title: d.name || '—',
              subtitle: d.proficiency || '',
              onDel: async ()=>{ await doc.ref.delete(); toast('Language removed'); }
            })
          );
        });
      });
  }

  function bindLists(){ bindExperience(); bindEducation(); bindSkills(); bindLanguages(); }

  // ---------- MODALS ----------
  const overlay = $('#modalOverlay');
  function openModal(id){ overlay.classList.remove('hidden'); $('#'+id).classList.remove('hidden'); }
  function closeModals(){ overlay.classList.add('hidden'); $$('.modal').forEach(m=>m.classList.add('hidden')); }

  $$('.btn-add').forEach(b=>{
    b.addEventListener('click', ()=> openModal(b.dataset.open));
  });
  overlay.addEventListener('click', closeModals);
  $$('[data-close]').forEach(b=> b.addEventListener('click', closeModals));

  // Save handlers
  $('#saveExperience').addEventListener('click', async ()=>{
    const company = $('#expCompany').value.trim();
    const title   = $('#expTitle').value.trim();
    const from    = $('#expFrom').value.trim();
    const to      = $('#expTo').value.trim();
    const desc    = $('#expDesc').value.trim();
    if(!company || !title){ toast('Company & Title required', false); return; }
    await db.collection('users').doc(user.uid).collection('experience').add({
      company, title, from, to, description: desc,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    closeModals(); toast('Experience added');
    ['expCompany','expTitle','expFrom','expTo','expDesc'].forEach(id=>$('#'+id).value='');
  });

  $('#saveEducation').addEventListener('click', async ()=>{
    const school = $('#eduSchool').value.trim();
    const degree = $('#eduDegree').value.trim();
    const year   = $('#eduYear').value.trim();
    const notes  = $('#eduNotes').value.trim();
    if(!school){ toast('School is required', false); return; }
    await db.collection('users').doc(user.uid).collection('education').add({
      school, degree, year, notes,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    closeModals(); toast('Education added');
    ['eduSchool','eduDegree','eduYear','eduNotes'].forEach(id=>$('#'+id).value='');
  });

  $('#saveSkill').addEventListener('click', async ()=>{
    const name  = $('#skillName').value.trim();
    const level = $('#skillLevel').value;
    if(!name){ toast('Skill name required', false); return; }
    await db.collection('users').doc(user.uid).collection('skills').add({
      name, level,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    closeModals(); toast('Skill added');
    $('#skillName').value=''; $('#skillLevel').value='Intermediate';
  });

  $('#saveLanguage').addEventListener('click', async ()=>{
    const name = $('#langName').value.trim();
    const proficiency = $('#langProficiency').value;
    if(!name){ toast('Language name required', false); return; }
    await db.collection('users').doc(user.uid).collection('languages').add({
      name, proficiency,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    closeModals(); toast('Language added');
    $('#langName').value=''; $('#langProficiency').value='Conversational';
  });

  // ---------- QUICK ----------
  $('#refreshBtn').addEventListener('click', ()=> location.reload());
  $('#exportBtn').addEventListener('click', async ()=>{
    const base = (await db.collection('users').doc(user.uid).get()).data()||{};
    const [exp,edu,skills,langs] = await Promise.all([
      db.collection('users').doc(user.uid).collection('experience').get(),
      db.collection('users').doc(user.uid).collection('education').get(),
      db.collection('users').doc(user.uid).collection('skills').get(),
      db.collection('users').doc(user.uid).collection('languages').get(),
    ]);
    const out = {
      uid: user.uid, email: user.email,
      profile: base,
      experience: exp.docs.map(d=>({id:d.id,...d.data()})),
      education:  edu.docs.map(d=>({id:d.id,...d.data()})),
      skills:     skills.docs.map(d=>({id:d.id,...d.data()})),
      languages:  langs.docs.map(d=>({id:d.id,...d.data()})),
    };
    const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `pehchaansetu-profile-${user.uid}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // ---------- SIGN OUT ----------
  $('#signOutBtn').addEventListener('click', async ()=>{
    await firebase.auth().signOut();
    location.href = 'auth-login.html';
  });

  // Edit profile (just focuses About for now)
  $('#editProfileBtn').addEventListener('click', ()=>{
    $$('.tab').forEach(b=> b.classList.remove('tab-active','text-white','tab-inactive'));
    $$('[data-tab]').forEach(b=>{ b.classList.add('tab-inactive'); });
    $('[data-tab="about"]').classList.remove('tab-inactive');
    $('[data-tab="about"]').classList.add('tab-active','text-white');
    ['about','activity','experience','education','skills','languages'].forEach(id => $('#panel-'+id).classList.add('hidden'));
    $('#panel-about').classList.remove('hidden');
    $('#aboutInput').focus();
  });
<!-- BEGIN: Add-button fallback & robust binder -->
<script>
(function(){
  if (!window.firebase) {
    console.error('Firebase not loaded — cannot attach Add handlers.');
    return;
  }
  const db = firebase.firestore();
  let currentUid = null;
  firebase.auth().onAuthStateChanged(u => { if(u) currentUid = u.uid; });

  function toast(msg, ok=true){
    const el = document.createElement('div');
    el.textContent = msg;
    el.style.position = 'fixed';
    el.style.bottom = '16px';
    el.style.left = '50%';
    el.style.transform = 'translateX(-50%)';
    el.style.padding = '8px 14px';
    el.style.borderRadius = '8px';
    el.style.color = 'white';
    el.style.fontSize = '14px';
    el.style.zIndex = 9999;
    el.style.background = ok ? '#16a34a' : '#ef4444';
    document.body.appendChild(el);
    setTimeout(()=> el.remove(), 2200);
  }

  // openModal id-based if exists (keeps current modal behavior)
  function openModalId(id){
    const overlay = document.getElementById('modalOverlay') || document.getElementById('modal-overlay');
    const modal = document.getElementById(id);
    if(modal) {
      if (overlay) overlay.classList.remove('hidden');
      modal.classList.remove('hidden');
      return true;
    }
    return false;
  }

  // fallback simple form prompt (for quick add). Saves to Firestore collectionName
  async function promptAndSave(collectionName, fields){
    if (!currentUid) { toast('Sign-in required', false); return; }
    // build a simple prompt UI
    const container = document.createElement('div');
    container.style.position = 'fixed';
    container.style.left = '50%';
    container.style.top = '50%';
    container.style.transform = 'translate(-50%,-50%)';
    container.style.zIndex = 10000;
    container.style.background = '#fff';
    container.style.padding = '18px';
    container.style.borderRadius = '10px';
    container.style.boxShadow = '0 10px 30px rgba(0,0,0,.12)';
    container.style.minWidth = '320px';
    container.innerHTML = `<div style="font-weight:600;margin-bottom:10px">Add ${collectionName}</div>`;
    fields.forEach(f=>{
      const el = document.createElement('input');
      el.placeholder = f.placeholder || f.name;
      el.name = f.name;
      el.style.width = '100%';
      el.style.padding = '8px';
      el.style.margin = '6px 0';
      el.style.border = '1px solid #e5e7eb';
      el.style.borderRadius = '6px';
      container.appendChild(el);
    });
    const btnSave = document.createElement('button');
    btnSave.textContent = 'Save';
    btnSave.style.marginRight = '8px';
    btnSave.style.padding = '8px 12px';
    btnSave.style.background = '#2563eb';
    btnSave.style.color = 'white';
    btnSave.style.border = 'none';
    btnSave.style.borderRadius = '6px';
    const btnCancel = document.createElement('button');
    btnCancel.textContent = 'Cancel';
    btnCancel.style.padding = '8px 12px';
    btnCancel.style.background = '#f3f4f6';
    btnCancel.style.border = 'none';
    btnCancel.style.borderRadius = '6px';
    container.appendChild(document.createElement('div'));
    container.appendChild(btnSave);
    container.appendChild(btnCancel);
    document.body.appendChild(container);

    btnCancel.addEventListener('click', ()=> container.remove());
    btnSave.addEventListener('click', async ()=>{
      // gather values
      const values = {};
      fields.forEach((f, i)=>{
        const v = container.querySelectorAll('input')[i].value.trim();
        values[f.name] = v;
      });

      // minimal validation: require first non-empty field
      const firstField = fields[0] && fields[0].name;
      if (firstField && !values[firstField]) {
        toast('Please fill required field', false);
        return;
      }
      try {
        await db.collection('users').doc(currentUid).collection(collectionName).add({
          ...values,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        toast(`${collectionName} added`);
        container.remove();
      } catch(e){
        console.error('Save fallback error', e);
        toast('Save failed', false);
      }
    });
  }

  // universal binder for any .btn-add or [data-open]
  function attachAddButtonHandlers(){
    // for elements with data-open use normal modal behavior
    const dataOpenEls = document.querySelectorAll('[data-open]');
    dataOpenEls.forEach(el => {
      // attach only once
      if (el.__addBound) return;
      el.__addBound = true;
      el.addEventListener('click', (ev) => {
        const id = el.dataset.open;
        if (!id) {
          // fallback - treat as collection name (lowercase)
          const col = (el.dataset.collection || el.textContent || 'items').toString().trim().toLowerCase();
          // choose sensible fields depending on col
          if (col.includes('edu') || col.includes('education')) {
            promptAndSave('education', [
              { name:'school', placeholder:'School / College' },
              { name:'degree', placeholder:'Degree' },
              { name:'year', placeholder:'Year' },
              { name:'notes', placeholder:'Notes' }
            ]);
            return;
          }
          if (col.includes('exp') || col.includes('experience')) {
            promptAndSave('experience', [
              { name:'company', placeholder:'Company' },
              { name:'title', placeholder:'Title' },
              { name:'from', placeholder:'From (YYYY)' },
              { name:'to', placeholder:'To (YYYY or Present)' }
            ]);
            return;
          }
          // generic fallback
          promptAndSave('items', [{ name:'title', placeholder:'Title' }]);
          return;
        }
        // modal exists? try to open it; if not, fallback to prompt
        if (!openModalId(id)) {
          // decide fallback collection based on id
          if (id.toLowerCase().includes('edu')) {
            promptAndSave('education', [
              { name:'school', placeholder:'School / College' },
              { name:'degree', placeholder:'Degree' },
              { name:'year', placeholder:'Year' },
              { name:'notes', placeholder:'Notes' }
            ]);
            return;
          } else if (id.toLowerCase().includes('exp')) {
            promptAndSave('experience', [
              { name:'company', placeholder:'Company' },
              { name:'title', placeholder:'Title' },
              { name:'from', placeholder:'From (YYYY)' },
              { name:'to', placeholder:'To (YYYY or Present)' }
            ]);
            return;
          } else {
            // generic
            promptAndSave(id, [{ name:'title', placeholder:'Title' }]);
            return;
          }
        }
      });
    });

    // also bind .btn-add (some UIs use that)
    const addEls = document.querySelectorAll('.btn-add, .add-btn, .addButton');
    addEls.forEach(el=>{
      if (el.__btnBound) return;
      el.__btnBound = true;
      el.addEventListener('click', (e)=>{
        // prefer data-open -> fallback to data-collection -> fallback to text
        const id = el.dataset.open || el.dataset.collection || el.getAttribute('data-target') || el.getAttribute('aria-controls') || el.textContent;
        if (!id) {
          // generic open education prompt
          promptAndSave('education', [
            { name:'school', placeholder:'School / College' },
            { name:'degree', placeholder:'Degree' },
            { name:'year', placeholder:'Year' },
            { name:'notes', placeholder:'Notes' }
          ]);
          return;
        }
        // if id looks like modal id (contains 'modal' or 'edu' etc) try openModalId
        const targetId = (id+'').trim();
        if (!openModalId(targetId)) {
          // if opening modal failed, try sensible collection
          if (targetId.toLowerCase().includes('edu') || targetId.toLowerCase().includes('education')) {
            promptAndSave('education', [
              { name:'school', placeholder:'School / College' },
              { name:'degree', placeholder:'Degree' },
              { name:'year', placeholder:'Year' },
              { name:'notes', placeholder:'Notes' }
            ]);
            return;
          }
          if (targetId.toLowerCase().includes('exp')) {
            promptAndSave('experience', [
              { name:'company', placeholder:'Company' },
              { name:'title', placeholder:'Title' },
              { name:'from', placeholder:'From (YYYY)' },
              { name:'to', placeholder:'To (YYYY or Present)' }
            ]);
            return;
          }
          // fallback generic
          promptAndSave('items', [{ name:'title', placeholder:'Title' }]);
        }
      });
    });
  }

  // Attach after DOM loaded (also call after any dynamic render)
  document.addEventListener('DOMContentLoaded', attachAddButtonHandlers);
  // ensure binder runs again shortly (for cases where UI generated later)
  setTimeout(attachAddButtonHandlers, 800);
  setTimeout(attachAddButtonHandlers, 2200);
})();
</script>
<!-- END: Add-button fallback & robust binder -->

    
  </script>
</body>
</html>
