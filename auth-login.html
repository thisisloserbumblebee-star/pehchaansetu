<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pehchaan Setu — Login</title>

  <!-- compat SDKs (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <!-- your firebase-config.js (must call firebase.initializeApp({...})) -->
  <script src="firebase-config.js"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, Arial; background:#f7fafc; }
    .card { max-width:520px; margin:80px auto; background:#fff; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,.06); padding:36px; }
    h1{ color:#2546c2; text-align:center; margin-bottom:18px; }
    input{ width:100%; padding:12px 14px; margin:10px 0; border-radius:6px; border:1px solid #e6e9ef; box-sizing:border-box; }
    button{ background:#2563eb; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer;}
    .error{ color:#b91c1c; margin-top:12px; white-space:pre-wrap; }
    .smalllink{ color:#2563eb; text-decoration:none; margin-left:14px; }
    .debug { color:#0b7; font-size:12px; margin-top:8px; }
  </style>
</head>
<body>

  <div class="card" role="main" aria-labelledby="pageTitle">
    <h1 id="pageTitle">Login</h1>

    <label for="email" style="display:none">Email</label>
    <input id="email" type="email" placeholder="Email" autocomplete="email" />

    <label for="password" style="display:none">Password</label>
    <input id="password" type="password" placeholder="Password (6+ chars)" autocomplete="current-password" />

    <div style="display:flex; justify-content:flex-start; align-items:center; gap:12px; margin-top:6px;">
      <button id="signinBtn" type="button">Sign in</button>
      <a class="smalllink" href="auth-signup.html">Create account</a>
    </div>

    <div id="error" class="error" role="alert" aria-live="polite"></div>
    <div id="debug" class="debug" aria-hidden="true"></div>
  </div>

  <script>
(function(){
  const ABSOLUTE_PROFILE_URL = 'https://thisisloserbumblebee-star.github.io/pehchaansetu/profile.html';
  const errorEl = document.getElementById('error');
  const debugLog = (s) => {
    console.log('[auth-debug]', s);
    // also show short status on page
    const d = document.getElementById('__auth_debug');
    if (d) d.textContent = String(s);
  };

  // add small on-page debug element
  if (!document.getElementById('__auth_debug')) {
    const dd = document.createElement('div');
    dd.id = '__auth_debug';
    dd.style.fontSize = '12px';
    dd.style.color = '#0b7';
    dd.style.marginTop = '8px';
    document.querySelector('.card').appendChild(dd);
  }

  function showError(msg){
    console.error('[auth-debug]', msg);
    errorEl.textContent = typeof msg === 'string' ? msg : (msg && msg.message) ? msg.message : String(msg);
  }

  function tryForceNavigate(url){
    debugLog('FORCE NAVIGATE -> ' + url);

    // 1) Try top (may fail cross-origin)
    try {
      if (window.top && window.top !== window) {
        debugLog('Trying window.top.location.href');
        window.top.location.href = url;
        return true;
      }
    } catch(e){
      debugLog('top assign failed: ' + e);
    }

    // 2) open in _top via window.open
    try {
      debugLog('Trying window.open(..., \"_top\")');
      const win = window.open(url, '_top');
      if (win) {
        debugLog('window.open returned window object');
        return true;
      }
    } catch(e){
      debugLog('window.open(_top) failed: ' + e);
    }

    // 3) replace current location
    try {
      debugLog('Trying location.replace');
      window.location.replace(url);
      return true;
    } catch(e){
      debugLog('location.replace failed: ' + e);
    }

    // 4) direct href fallback
    try {
      debugLog('Trying location.href assignment');
      window.location.href = url;
      return true;
    } catch(e){
      debugLog('location.href failed: ' + e);
    }

    debugLog('All navigation attempts done — none threw, check browser blocking rules.');
    return false;
  }

  function waitForFirebase(timeoutMs = 4000){
    return new Promise((resolve, reject) => {
      const start = Date.now();
      (function check(){
        if (window.firebase && typeof window.firebase.auth === 'function') {
          try {
            if (firebase.apps && firebase.apps.length > 0) {
              return resolve(firebase);
            }
          } catch(e){ /* ignore */ }
        }
        if (Date.now() - start > timeoutMs) return reject(new Error('Firebase not ready'));
        setTimeout(check, 120);
      })();
    });
  }

  waitForFirebase().then(firebase => {
    debugLog('Firebase compat ready. Project: ' + ((firebase.app && firebase.app().options && firebase.app().options.projectId) || 'unknown'));
    const auth = firebase.auth();

    // Listen for auth state changes and log currentUser
    if (typeof auth.onAuthStateChanged === 'function') {
      auth.onAuthStateChanged(user => {
        debugLog('onAuthStateChanged fired. user=' + (user ? (user.email || user.uid) : 'null'));
        if (user) {
          // log details then force navigation
          console.log('[auth-debug] currentUser object:', user);
          // attempt to navigate but wait a tick to ensure browser completes auth cookie/token actions
          setTimeout(() => tryForceNavigate(ABSOLUTE_PROFILE_URL), 150);
        }
      });
    } else {
      debugLog('auth.onAuthStateChanged not found');
    }

    // button handler
    const signBtn = document.getElementById('signinBtn');
    const emailEl = document.getElementById('email');
    const pwEl = document.getElementById('password');

    signBtn.addEventListener('click', function(){
      errorEl.textContent = '';
      const email = (emailEl.value || '').trim();
      const pw = pwEl.value || '';
      if (!email || !pw) { showError('Enter email & password'); return; }

      signBtn.disabled = true;
      signBtn.textContent = 'Signing in...';
      debugLog('Calling signInWithEmailAndPassword for ' + email);

      auth.signInWithEmailAndPassword(email, pw)
      .then(cred => {
        debugLog('signInWithEmailAndPassword PROMISE resolved. cred: ' + JSON.stringify({
          userUid: cred && cred.user && cred.user.uid,
          userEmail: cred && cred.user && cred.user.email
        }));
        // double-check currentUser
        debugLog('auth.currentUser after signIn: ' + (auth.currentUser ? (auth.currentUser.email || auth.currentUser.uid) : 'null'));
        // Try to force navigation right away
        tryForceNavigate(ABSOLUTE_PROFILE_URL);
        // As an extra: try opening a new tab (user gesture) if allowed
        try {
          const newWin = window.open(ABSOLUTE_PROFILE_URL, '_blank');
          debugLog('window.open _blank returned: ' + String(newWin));
        } catch(e){ debugLog('window.open _blank error: ' + e); }
      })
      .catch(err => {
        console.error('Sign-in error', err);
        showError(err && err.message ? err.message : JSON.stringify(err));
      })
      .finally(() => {
        signBtn.disabled = false;
        signBtn.textContent = 'Sign in';
      });
    });

    // allow Enter
    [document.getElementById('email'), document.getElementById('password')].forEach(el=>{
      el.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('signinBtn').click(); }});
    });

    debugLog('Auth handlers installed.');

  }).catch(err => {
    showError('Firebase init/wait error: ' + (err && err.message ? err.message : String(err)));
    console.error(err);
  });

})();
</script>

</body>
</html>
